<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>잠재 인수 모델 (Latent Factor Model) - 막돼먹은 엔지니어의 머신런닝 개발</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="잠재 인수 모델 (Latent Factor Model)" />
<meta property="og:description" content="영화나 상품 추천에 사용되는 잠재 인수 모델(Latent Factor Model)을 살펴 보고 Keras로 모델링을 해보자!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/latent_factor_model/" />
<meta property="article:published_time" content="2019-09-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-09T00:00:00+00:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="막돼먹은 엔지니어의 머신런닝 개발" rel="home">
				<div class="logo__title">막돼먹은 엔지니어의 머신런닝 개발</div>
				<div class="logo__tagline">딥러닝 모델링</div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">잠재 인수 모델 (Latent Factor Model)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-09-09T00:00:00">2019-09-09</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/deep-learning" rel="category">Deep Learning</a>, <a class="meta__link" href="/categories/recommendation" rel="category">Recommendation</a></span>
</div>
</div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#문제-problem">문제 (Problem)</a></li>
<li><a href="#데이터-수집-data-collection">데이터 수집 (Data Collection)</a>
<ul>
<li><a href="#ratings-데이터프레임">Ratings 데이터프레임</a></li>
<li><a href="#movies-데이터프레임">Movies 데이터프레임</a></li>
</ul></li>
<li><a href="#데이터-클렌징-data-cleansing">데이터 클렌징 (Data Cleansing)</a></li>
<li><a href="#데이터-분석-data-analysis">데이터 분석 (Data Analysis)</a></li>
<li><a href="#미니-데이터-mini-data">미니 데이터 (Mini Data)</a>
<ul>
<li><a href="#잠재-인수-latent-factor">잠재 인수 (Latent factor)</a></li>
<li><a href="#행렬-인수-분해-matrix-factorization">행렬 인수 분해 (Matrix Factorization)</a></li>
<li><a href="#잠재-인수-찾기">잠재 인수 찾기</a></li>
<li><a href="#keras를-이용한-미니-모델링">Keras를 이용한 미니 모델링</a>
<ul>
<li><a href="#데이터-변환-data-transformation">데이터 변환 (Data Transformation)</a></li>
<li><a href="#임베딩-embedding">임베딩 (Embedding)</a></li>
<li><a href="#벡터화-flattern">벡터화 (Flattern)</a></li>
<li><a href="#미니-모델링-modeling">미니 모델링 (Modeling)</a></li>
<li><a href="#미니-모델-훈련-train-model">미니 모델 훈련 (Train Model)</a></li>
<li><a href="#미니-예측-predict">미니 예측 (Predict)</a></li>
</ul></li>
</ul></li>
<li><a href="#잠재-인수-모델링-latent-factor-modeling">잠재 인수 모델링 (Latent Factor Modeling)</a>
<ul>
<li><a href="#손실함수-loss-function">손실함수 (Loss function)</a></li>
<li><a href="#최적화-optimization">최적화 (Optimization)</a></li>
<li><a href="#정리">정리</a></li>
</ul></li>
<li><a href="#케라스-keras-로-모델링-modeling">케라스(Keras)로 모델링(Modeling)</a>
<ul>
<li><a href="#데이터-변환">데이터 변환</a></li>
<li><a href="#훈련-테스트-데이터-분할">훈련, 테스트 데이터 분할</a></li>
<li><a href="#임베딩-embedding-1">임베딩 (Embedding)</a></li>
<li><a href="#벡터화-flatten">벡터화 (Flatten)</a></li>
<li><a href="#모델링-modeling">모델링 (Modeling)</a></li>
<li><a href="#모델-훈련-train-model">모델 훈련 (Train Model)</a></li>
<li><a href="#모델-평가-test-model">모델 평가 (Test Model)</a></li>
</ul></li>
<li><a href="#해결-solution">해결 (Solution)</a></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<p>영화나 상품 추천에 사용되는 잠재 인수 모델(Latent Factor Model)을 살펴 보고 Keras로 모델링을 해보자!</p>

<p>실제로 돌려 보고 싶으면 구글 코랩으로 ~</p>

<p><a href="https://colab.research.google.com/github/skettee/notebooks/blob/master/latent_factor_model.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab" /></a></p>

<h2 id="문제-problem">문제 (Problem)</h2>

<p>👤 상사</p>

<blockquote>
<p>인공지능을 이용해서 영화를 추천하는 프로젝트를 시작한다<br />
데이터는 movielens에서 제공하는 데이터를 사용하게<br />
<a href="https://movielens.org/">https://movielens.org/</a></p>

<p>여기서 제공하는 영화 메타데이터와 사용자 별점을 이용해서<br />
영화에 대한 사용자의 별점을 예측하는 프로그램을 만들어 보게</p>
</blockquote>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>아니 보스&hellip; 사진 인식 프로젝트는 어떻게 하라고&hellip;<br />
막 지르는 구나&hellip;</p>
</blockquote>

<h2 id="데이터-수집-data-collection">데이터 수집 (Data Collection)</h2>

<p>데이터를 다운로드하고 파일로 저장하고 데이터프레임으로 변환하는 작업이 필요하다.</p>

<p>우리가 사용할 무비렌즈 데이터셋은 다음과 같다.</p>

<p><strong>MovieLens Latest Datasets</strong><br />
100,000 ratings and 3,600 tag applications applied to 9,000 movies by 600 users. Last updated <sup>9</sup>&frasl;<sub>2018</sub>.</p>

<ul>
<li><a href="http://files.grouplens.org/datasets/movielens/ml-latest-small-README.html">README.txt</a><br /></li>
<li>ml-latest-small.zip (size: 1 MB)</li>
<li><a href="http://files.grouplens.org/datasets/movielens/ml-latest-small.zip">http://files.grouplens.org/datasets/movielens/ml-latest-small.zip</a></li>
</ul>

<p>Zip파일을 풀면 아래의 데이터가 나온다. (README.txt 참조)</p>

<ol>
<li><p>ratings.csv</p>

<ul>
<li>파일 형식: userId, movieId, rating, timestamp</li>
<li>userId: 1 ~ 610 사이의 정수값<br /></li>
<li>movieId: 1 ~ 193609 사이의 정수값<br /></li>
<li>rating: 0.5 ~ 5.0 사이의 별점값 (0.5씩 증가)<br /></li>
<li>timestamp: 별점을 준 시간을 초로 표시  (1970.01.01 부터 UTC time)<br /></li>
</ul></li>

<li><p>movies.csv</p>

<ul>
<li>파일 형식: movieId, title, genres</li>
<li>movieId: 1 ~ 193609 사이의 정수값<br /></li>
<li>title: 영화 제목<br /></li>
<li>genres: 하나 이상의 장르가 &lsquo;|&rsquo; 로 연결되어 표시<br />
Action, Adventure, Animation, Children&rsquo;s, Comedy, Comedy, Documentary, Drama, Fantasy, Film-Noir, Horror, Musical, Mystery, Romance, Sci-Fi, Thriller, War, Western<br /></li>
</ul></li>
</ol>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>데이터를 다운로드 하고 데이터프레임으로 변환하자</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras.utils <span style="color:#f92672">import</span> get_file
<span style="color:#f92672">import</span> os

zip_fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ml-latest-small.zip&#39;</span>
data_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ml-latest-small&#39;</span>
ratings_fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ratings.csv&#39;</span>
movies_fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;movies.csv&#39;</span>
origin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://files.grouplens.org/datasets/movielens/ml-latest-small.zip&#39;</span>
path <span style="color:#f92672">=</span> get_file(zip_fname, origin, extract<span style="color:#f92672">=</span>True)

path <span style="color:#f92672">=</span> path<span style="color:#f92672">.</span>replace(zip_fname, data_dir)
ratings_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(path, ratings_fname)
movies_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(path, movies_fname)</code></pre></div>
<h3 id="ratings-데이터프레임">Ratings 데이터프레임</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

ratings_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(ratings_path)
ratings_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="movies-데이터프레임">Movies 데이터프레임</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">movies_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(movies_path)
movies_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <td>3</td>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <td>4</td>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>#번 사용자가 5개 별점을 준 영화 리스트</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">userId <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#75715e"># 1~610</span>
rating <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>  <span style="color:#75715e"># 1 ~ 5</span>
top_movie_ids <span style="color:#f92672">=</span> ratings_df[(ratings_df[<span style="color:#e6db74">&#39;userId&#39;</span>] <span style="color:#f92672">==</span> userId) 
                           <span style="color:#f92672">&amp;</span> (ratings_df[<span style="color:#e6db74">&#39;rating&#39;</span>] <span style="color:#f92672">==</span> rating)]<span style="color:#f92672">.</span>movieId
top_titles <span style="color:#f92672">=</span> movies_df[movies_df[<span style="color:#e6db74">&#39;movieId&#39;</span>]<span style="color:#f92672">.</span>isin(top_movie_ids)]<span style="color:#f92672">.</span>title

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Top rated titles of userId {}:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(userId))
<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> top_titles:
    <span style="color:#66d9ef">print</span>(item)</code></pre></div>
<pre><code>Top rated titles of userId 100:

Top Gun (1986)
Terms of Endearment (1983)
Christmas Vacation (National Lampoon's Christmas Vacation) (1989)
Officer and a Gentleman, An (1982)
Sweet Home Alabama (2002)
</code></pre>

<h2 id="데이터-클렌징-data-cleansing">데이터 클렌징 (Data Cleansing)</h2>

<p>데이터가 구멍이 난 것이 없는지 확인</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Check missing data</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;missing number of userId data is &#39;</span>, ratings_df[<span style="color:#e6db74">&#39;userId&#39;</span>]<span style="color:#f92672">.</span>isnull()<span style="color:#f92672">.</span>sum())
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;missing number of movieId data is &#39;</span>, ratings_df[<span style="color:#e6db74">&#39;movieId&#39;</span>]<span style="color:#f92672">.</span>isnull()<span style="color:#f92672">.</span>sum())
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;missing number of rating data is &#39;</span>, ratings_df[<span style="color:#e6db74">&#39;rating&#39;</span>]<span style="color:#f92672">.</span>isnull()<span style="color:#f92672">.</span>sum())</code></pre></div>
<pre><code>missing number of userId data is  0
missing number of movieId data is  0
missing number of rating data is  0
</code></pre>

<h2 id="데이터-분석-data-analysis">데이터 분석 (Data Analysis)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} Ratings, {} Users, {} Movies&#39;</span><span style="color:#f92672">.</span>format(len(ratings_df), 
                                               len(ratings_df<span style="color:#f92672">.</span>userId<span style="color:#f92672">.</span>unique()), 
                                               len(ratings_df<span style="color:#f92672">.</span>movieId<span style="color:#f92672">.</span>unique())))</code></pre></div>
<pre><code>100836 Ratings, 610 Users, 9724 Movies
</code></pre>

<p><code>userId</code>를 컬럼(Column), <code>movieId</code>를 열(Row)로 만들어서 <code>rating</code>값을 확인해 보자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df_table <span style="color:#f92672">=</span> ratings_df<span style="color:#f92672">.</span>set_index([<span style="color:#e6db74">&#34;movieId&#34;</span>, <span style="color:#e6db74">&#34;userId&#34;</span>])<span style="color:#f92672">.</span>unstack()
df_table<span style="color:#f92672">.</span>shape</code></pre></div>
<pre><code>(9724, 1220)
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df_table<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">808</span>:<span style="color:#ae81ff">817</span>, <span style="color:#ae81ff">212</span>:<span style="color:#ae81ff">222</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#34;&#34;</span>)</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="10" halign="left">rating</th>
    </tr>
    <tr>
      <th>userId</th>
      <th>213</th>
      <th>214</th>
      <th>215</th>
      <th>216</th>
      <th>217</th>
      <th>218</th>
      <th>219</th>
      <th>220</th>
      <th>221</th>
      <th>222</th>
    </tr>
    <tr>
      <th>movieId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1057</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1059</td>
      <td></td>
      <td>4</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>2</td>
    </tr>
    <tr>
      <td>1060</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1061</td>
      <td></td>
      <td></td>
      <td>3.5</td>
      <td></td>
      <td>3</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1064</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1066</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1068</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1073</td>
      <td></td>
      <td>3</td>
      <td></td>
      <td></td>
      <td>3</td>
      <td></td>
      <td>2.5</td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>1077</td>
      <td></td>
      <td></td>
      <td></td>
      <td>3</td>
      <td>2</td>
      <td></td>
      <td></td>
      <td></td>
      <td>4</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>빵꾸가 많이 보인다&hellip;<br />
별점이 비어 있는 빵꾸난 부분을<br />
우리가 만들 모델을 통해서<br />
별점을 예측해서 채워 넣어야 한다.</p>

<p>어떻게?</p>
</blockquote>

<h2 id="미니-데이터-mini-data">미니 데이터 (Mini Data)</h2>

<p>데이터가 크고 불완전하면 이해하기도 어렵고 다루기도 어렵다.<br />
미니 데이터를 만들어서 솔루션을 찾아보자!</p>

<p>5편의 영화에 대해서 4명이 별점을 매긴 데이터가 있다.</p>

<table>
<thead>
<tr>
<th>영화 \ 사용자</th>
<th>Alice</th>
<th>Bob</th>
<th>Carol</th>
<th>Dave</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>뷰티인사이드</strong></td>
<td>5</td>
<td>5</td>
<td>1</td>
<td>1</td>
</tr>

<tr>
<td><strong>라라랜드</strong></td>
<td>5</td>
<td>4</td>
<td>1</td>
<td>1</td>
</tr>

<tr>
<td><strong>러브스토리</strong></td>
<td>5</td>
<td>5</td>
<td>1</td>
<td>1</td>
</tr>

<tr>
<td><strong>매트릭스</strong></td>
<td>1</td>
<td>1</td>
<td>5</td>
<td>5</td>
</tr>

<tr>
<td><strong>스타워즈</strong></td>
<td>1</td>
<td>1</td>
<td>5</td>
<td>4</td>
</tr>
</tbody>
</table>

<p>우리는 여기서 앨리스(Alice), 밥(Bob), 캐롤(Carol), 데이브(Dave)를 분류할 수 있는 특징과<br />
뷰티 인사이드, 라라랜드, 러브 스토리, 매트릭스, 스타워즈를 분류 할 수 있는 특징을 발견할 것이다.</p>

<p>영화를 보자<br />
뷰티 인사이드, 라라랜드, 러브 스토리는 &lsquo;로맨틱 영화&rsquo;로 분류할 수 있고,<br />
매트릭스와 스타워즈는 &lsquo;공상과학 영화&rsquo;로 분류할 수 있다.</p>

<table>
<thead>
<tr>
<th>영화 \ 특징</th>
<th>로맨틱 영화</th>
<th>공상과학 영화</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>뷰티인사이드</strong></td>
<td>높은 점수</td>
<td>낮은 점수</td>
</tr>

<tr>
<td><strong>라라랜드</strong></td>
<td>높은 점수</td>
<td>낮은 점수</td>
</tr>

<tr>
<td><strong>러브스토리</strong></td>
<td>높은 점수</td>
<td>낮은 점수</td>
</tr>

<tr>
<td><strong>매트릭스</strong></td>
<td>낮은 점수</td>
<td>높은 점수</td>
</tr>

<tr>
<td><strong>스타워즈</strong></td>
<td>낮은 점수</td>
<td>높은 점수</td>
</tr>
</tbody>
</table>

<p>사용자를 보자<br />
앨리스와 밥은 로맨틱 영화를 좋아하고 공상과학 영화를 좋아하지 않는 &lsquo;로맨틱한 사람&rsquo;으로 분류할 수 있고,<br />
캐롤과 데이브는 공상과학 영화를 좋아하고 로맨틱 영화를 좋아하지 않는 &lsquo;상상력이 풍부한 사람&rsquo;으로 분류할 수 있다.</p>

<table>
<thead>
<tr>
<th>특징 \ 사용자</th>
<th>Alice</th>
<th>Bob</th>
<th>Carol</th>
<th>Dave</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>로맨틱한 사람</strong></td>
<td>높은 점수</td>
<td>높은 점수</td>
<td>낮은 점수</td>
<td>낮은 점수</td>
</tr>

<tr>
<td><strong>상상력이 풍부한 사람</strong></td>
<td>낮은 점수</td>
<td>낮은 점수</td>
<td>높은 점수</td>
<td>높은 점수</td>
</tr>
</tbody>
</table>

<h3 id="잠재-인수-latent-factor">잠재 인수 (Latent factor)</h3>

<p>&lsquo;로맨틱 영화&rsquo;, &lsquo;상상력이 풍부한 사람&rsquo;과 같은 피쳐(feature)는 데이터에서는 보이지 않는다.<br />
이와같이 데이터들 속에 숨어있는 특징을 <strong>잠재 인수(Latent factor)</strong> 라고 한다.</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>잠재 인수(Latent factor)의 값들이<br />
영화의 특징을 보여주고<br />
평가자의 특징을 보여 주면서<br />
별점수까지 보여 주는 방법이 없을까?</p>

<p>있다! 그것은 바로&hellip;</p>
</blockquote>

<h3 id="행렬-인수-분해-matrix-factorization">행렬 인수 분해 (Matrix Factorization)</h3>

<p>별점 매트릭스를 \(R\)라고 하자</p>

<p>\(R= \begin{bmatrix}
5 &amp; 5 &amp; 1 &amp; 1  \\
5 &amp; 4 &amp; 1 &amp; 1  \\
5 &amp; 5 &amp; 1 &amp; 1  \\
1 &amp; 1 &amp; 5 &amp; 5  \\
1 &amp; 1 &amp; 5 &amp; 4
\end{bmatrix}\)</p>

<p>우리는 이제 \(R\) (5X4) 매트릭스를 \(Q\) (5X2)와 \(P^T\) (2X4) 매트릭스로 분해를 할 것이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Non-negative matrix factorization</span>
<span style="color:#f92672">from</span> sklearn.decomposition <span style="color:#f92672">import</span> NMF
R <span style="color:#f92672">=</span> [
     [<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],
     [<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],
     [<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],
     [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>],
     [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>],
    ]

k <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e"># number of factors</span>
model <span style="color:#f92672">=</span> NMF(n_components<span style="color:#f92672">=</span>k)
Q <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit_transform(np<span style="color:#f92672">.</span>array(R))
P <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>components_</code></pre></div>
<p>아래 \(Q\) 매트릭스를 보자.</p>

<p>0번 컬럼(Column)을 &lsquo;로맨틱 영화&rsquo;,<br />
1번 컬럼(Column)을 &lsquo;공상과학 영화&rsquo; 라고 하면<br />
\(Q\) 매트릭스는 영화의 특징을 나타내고 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Q (5X2) 매트릭스</span>
pd<span style="color:#f92672">.</span>DataFrame(Q, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Romantic&#39;</span>, <span style="color:#e6db74">&#39;Sci-Fi&#39;</span>])</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Romantic</th>
      <th>Sci-Fi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.931132</td>
      <td>0.000002</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.744253</td>
      <td>0.047301</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.931132</td>
      <td>0.000002</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.376532</td>
      <td>2.425963</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.375488</td>
      <td>2.186905</td>
    </tr>
  </tbody>
</table>
</div>

<p>아래 \(P^T\) 매트릭스를 보자.</p>

<p>0번 열(Row)을 &lsquo;로맨틱한 사람&rsquo;,<br />
1번 열(Row)을 &lsquo;상상력이 풍부한 사람&rsquo; 이라고 하면<br />
\(P^T\) 매트릭스는 사용자의 특징을 나타내고 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># P (2X4) 매트릭스</span>
pd<span style="color:#f92672">.</span>DataFrame(P, index<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Romantic Guy&#39;</span>, <span style="color:#e6db74">&#39;Imaginary Guy&#39;</span>])</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Romantic Guy</td>
      <td>2.669263</td>
      <td>2.503536</td>
      <td>0.518479</td>
      <td>0.518187</td>
    </tr>
    <tr>
      <td>Imaginary Guy</td>
      <td>0.000000</td>
      <td>0.023698</td>
      <td>2.077725</td>
      <td>1.872818</td>
    </tr>
  </tbody>
</table>
</div>

<p>마지막으로 \(Q\)와 \(P^T\) 매트릭스가<br />
별점을 표현하는 지를 확인하기 위해서<br />
\(Q\)와 \(P^T\)를 곱해 보자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">R_hat <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(Q,P)
pd<span style="color:#f92672">.</span>DataFrame(R_hat)</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>5.154699</td>
      <td>4.834659</td>
      <td>1.001255</td>
      <td>1.000692</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4.655871</td>
      <td>4.367922</td>
      <td>1.002637</td>
      <td>0.992436</td>
    </tr>
    <tr>
      <td>2</td>
      <td>5.154699</td>
      <td>4.834659</td>
      <td>1.001255</td>
      <td>1.000692</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.005062</td>
      <td>1.000152</td>
      <td>5.235708</td>
      <td>4.738501</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.002276</td>
      <td>0.991874</td>
      <td>4.738469</td>
      <td>4.290248</td>
    </tr>
  </tbody>
</table>
</div>

<p>\(R\)과 비슷한 값이 나온다.</p>

<p>이렇게  \(R \simeq Q \cdot P^T\) 를 <strong>행렬인수분해(Matrix Factorization)</strong> 라고 한다.</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>놀랍다!</p>

<p>평가자들의 영화 평점 매트릭스만 가지고<br />
평가자들의 잠재 인수(latent factor)와<br />
영화의 잠재 인수(latent factor)를<br />
추출할 수 있다.</p>

<p>수학이 이렇게 신기하고<br />
재미있다니&hellip;</p>

<p>학생때<br />
열심히 할걸&hellip;</p>

<p>그러나</p>

<p>별점이 빵꾸난 데이터에 대해서<br />
잠재 인수(Latent factor)를 어떻게 찾을까?</p>
</blockquote>

<h3 id="잠재-인수-찾기">잠재 인수 찾기</h3>

<p>앞에서 배운 선형회귀(Linear regression)를 기억해 보자</p>

<ol>
<li>\(\hat y=wx+b\)를 정의하고<br /></li>
<li>손실함수(Loss function) \(J(w,b)\)를 정의하고<br /></li>
<li>경사하강법(Gradient descent)으로 손실값이 최소가 되는 \(w, b\)를 찾았다.<br /></li>
</ol>

<p>이것을 잠재 인수 찾기에 활용해 보자</p>

<ol>
<li>\(\hat r=q \cdot p^T\)를 정의하고<br /></li>
<li>손실함수(Loss function) \(J(p,q)\)를 정의하고<br /></li>
<li>경사하강법(Gradient descent)으로 손실값이 최소가 되는 \(p, q\)를 찾으면 되지 않을까?<br /></li>
</ol>

<h3 id="keras를-이용한-미니-모델링">Keras를 이용한 미니 모델링</h3>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>좋았어!</p>

<p>미니 데이터를 가지고 확인 해보자</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

data <span style="color:#f92672">=</span> [
    [<span style="color:#e6db74">&#39;Alice&#39;</span>, <span style="color:#e6db74">&#39;Beauty Inside&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Alice&#39;</span>, <span style="color:#e6db74">&#39;La La Land&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Alice&#39;</span>, <span style="color:#e6db74">&#39;Love Story&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Alice&#39;</span>, <span style="color:#e6db74">&#39;Matrix&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Alice&#39;</span>, <span style="color:#e6db74">&#39;Star Wars&#39;</span>, <span style="color:#ae81ff">1</span>], 
    [<span style="color:#e6db74">&#39;Bob&#39;</span>, <span style="color:#e6db74">&#39;La La Land&#39;</span>, <span style="color:#ae81ff">4</span>],
    [<span style="color:#e6db74">&#39;Bob&#39;</span>, <span style="color:#e6db74">&#39;Love Story&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Bob&#39;</span>, <span style="color:#e6db74">&#39;Matrix&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Bob&#39;</span>, <span style="color:#e6db74">&#39;Star Wars&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Carol&#39;</span>, <span style="color:#e6db74">&#39;Beauty Inside&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Carol&#39;</span>, <span style="color:#e6db74">&#39;La La Land&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Carol&#39;</span>, <span style="color:#e6db74">&#39;Matrix&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Carol&#39;</span>, <span style="color:#e6db74">&#39;Star Wars&#39;</span>, <span style="color:#ae81ff">5</span>], 
    [<span style="color:#e6db74">&#39;Dave&#39;</span>, <span style="color:#e6db74">&#39;Beauty Inside&#39;</span>, <span style="color:#ae81ff">1</span>], 
    [<span style="color:#e6db74">&#39;Dave&#39;</span>, <span style="color:#e6db74">&#39;La La Land&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Dave&#39;</span>, <span style="color:#e6db74">&#39;Love Story&#39;</span>, <span style="color:#ae81ff">1</span>],
    [<span style="color:#e6db74">&#39;Dave&#39;</span>, <span style="color:#e6db74">&#39;Matrix&#39;</span>, <span style="color:#ae81ff">5</span>],
    [<span style="color:#e6db74">&#39;Dave&#39;</span>, <span style="color:#e6db74">&#39;Star Wars&#39;</span>, <span style="color:#ae81ff">4</span>],
]

mini_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame( data <span style="color:#f92672">=</span> data, columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;item&#39;</span>, <span style="color:#e6db74">&#39;rating&#39;</span>])
mini_df</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>Alice</td>
      <td>Beauty Inside</td>
      <td>5</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Alice</td>
      <td>La La Land</td>
      <td>5</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Alice</td>
      <td>Love Story</td>
      <td>5</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Alice</td>
      <td>Matrix</td>
      <td>1</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Alice</td>
      <td>Star Wars</td>
      <td>1</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Bob</td>
      <td>La La Land</td>
      <td>4</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Bob</td>
      <td>Love Story</td>
      <td>5</td>
    </tr>
    <tr>
      <td>7</td>
      <td>Bob</td>
      <td>Matrix</td>
      <td>1</td>
    </tr>
    <tr>
      <td>8</td>
      <td>Bob</td>
      <td>Star Wars</td>
      <td>1</td>
    </tr>
    <tr>
      <td>9</td>
      <td>Carol</td>
      <td>Beauty Inside</td>
      <td>1</td>
    </tr>
    <tr>
      <td>10</td>
      <td>Carol</td>
      <td>La La Land</td>
      <td>1</td>
    </tr>
    <tr>
      <td>11</td>
      <td>Carol</td>
      <td>Matrix</td>
      <td>5</td>
    </tr>
    <tr>
      <td>12</td>
      <td>Carol</td>
      <td>Star Wars</td>
      <td>5</td>
    </tr>
    <tr>
      <td>13</td>
      <td>Dave</td>
      <td>Beauty Inside</td>
      <td>1</td>
    </tr>
    <tr>
      <td>14</td>
      <td>Dave</td>
      <td>La La Land</td>
      <td>1</td>
    </tr>
    <tr>
      <td>15</td>
      <td>Dave</td>
      <td>Love Story</td>
      <td>1</td>
    </tr>
    <tr>
      <td>16</td>
      <td>Dave</td>
      <td>Matrix</td>
      <td>5</td>
    </tr>
    <tr>
      <td>17</td>
      <td>Dave</td>
      <td>Star Wars</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<p>영화 제목을 열(Row)로 하고 사용자 이름을 컬럼(Column)으로 테이블을 만들자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df_table <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>pivot_table(mini_df, values<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rating&#39;</span>, index<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;item&#39;</span>, columns<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user&#39;</span>, fill_value<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
df_table</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>user</th>
      <th>Alice</th>
      <th>Bob</th>
      <th>Carol</th>
      <th>Dave</th>
    </tr>
    <tr>
      <th>item</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Beauty Inside</td>
      <td>5.0</td>
      <td></td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>La La Land</td>
      <td>5.0</td>
      <td>4</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>Love Story</td>
      <td>5.0</td>
      <td>5</td>
      <td></td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>Matrix</td>
      <td>1.0</td>
      <td>1</td>
      <td>5</td>
      <td>5.0</td>
    </tr>
    <tr>
      <td>Star Wars</td>
      <td>1.0</td>
      <td>1</td>
      <td>5</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="데이터-변환-data-transformation">데이터 변환 (Data Transformation)</h4>

<p>사용자 이름과 영화 제목은 Keras가 입력을 받을 수 있도록 숫자로 변환이 되어야 한다.<br />
사용자(<code>user</code>)를 숫자로 변환해 보자</p>

<p>Alice가 0번, Bob이 1번, Carol이 2번, Dave가 3번으로 변환 되었다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">mini_df<span style="color:#f92672">.</span>user <span style="color:#f92672">=</span> mini_df<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;category&#39;</span>)<span style="color:#f92672">.</span>cat<span style="color:#f92672">.</span>codes<span style="color:#f92672">.</span>values
mini_df</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>Beauty Inside</td>
      <td>5</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>La La Land</td>
      <td>5</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0</td>
      <td>Love Story</td>
      <td>5</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0</td>
      <td>Matrix</td>
      <td>1</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0</td>
      <td>Star Wars</td>
      <td>1</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1</td>
      <td>La La Land</td>
      <td>4</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1</td>
      <td>Love Story</td>
      <td>5</td>
    </tr>
    <tr>
      <td>7</td>
      <td>1</td>
      <td>Matrix</td>
      <td>1</td>
    </tr>
    <tr>
      <td>8</td>
      <td>1</td>
      <td>Star Wars</td>
      <td>1</td>
    </tr>
    <tr>
      <td>9</td>
      <td>2</td>
      <td>Beauty Inside</td>
      <td>1</td>
    </tr>
    <tr>
      <td>10</td>
      <td>2</td>
      <td>La La Land</td>
      <td>1</td>
    </tr>
    <tr>
      <td>11</td>
      <td>2</td>
      <td>Matrix</td>
      <td>5</td>
    </tr>
    <tr>
      <td>12</td>
      <td>2</td>
      <td>Star Wars</td>
      <td>5</td>
    </tr>
    <tr>
      <td>13</td>
      <td>3</td>
      <td>Beauty Inside</td>
      <td>1</td>
    </tr>
    <tr>
      <td>14</td>
      <td>3</td>
      <td>La La Land</td>
      <td>1</td>
    </tr>
    <tr>
      <td>15</td>
      <td>3</td>
      <td>Love Story</td>
      <td>1</td>
    </tr>
    <tr>
      <td>16</td>
      <td>3</td>
      <td>Matrix</td>
      <td>5</td>
    </tr>
    <tr>
      <td>17</td>
      <td>3</td>
      <td>Star Wars</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<p>영화 제목(<code>item</code>)을 숫자로 변환한다.<br />
뷰티인사이드가 0, 라라랜드가 1, 러브스토리가 2, 매트릭스가 3, 스타워즈 4로 변환된 것을 확인 할 수 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">mini_df<span style="color:#f92672">.</span>item <span style="color:#f92672">=</span> mini_df<span style="color:#f92672">.</span>item<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;category&#39;</span>)<span style="color:#f92672">.</span>cat<span style="color:#f92672">.</span>codes<span style="color:#f92672">.</span>values
mini_df</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user</th>
      <th>item</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <td>7</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <td>8</td>
      <td>1</td>
      <td>4</td>
      <td>1</td>
    </tr>
    <tr>
      <td>9</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>10</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>11</td>
      <td>2</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <td>12</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <td>13</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>14</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>15</td>
      <td>3</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <td>16</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <td>17</td>
      <td>3</td>
      <td>4</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras <span style="color:#f92672">import</span> Model
<span style="color:#f92672">from</span> tensorflow.keras.layers <span style="color:#f92672">import</span> Input, Embedding, Flatten, dot
<span style="color:#f92672">from</span> tensorflow.keras <span style="color:#f92672">import</span> regularizers

item_input <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># mini_df.item</span>
user_input <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># mini_df.user</span></code></pre></div>
<h4 id="임베딩-embedding">임베딩 (Embedding)</h4>

<p>잠재 인수(Latent factor)의 모양(Shape)를 정의하고 모델에 삽입하는 것을 <strong>임베딩(Embedding)</strong> 이라고 한다.<br />
임베딩(Embedding)된 값들은 모델이 훈련되면서 학습이 된다. 다시 말하면 손실함수(Loss function)가 최저값을 찾아가는 과정에서 최적의 값으로 자동으로 세팅된다.<br />
영화(<code>item</code>)에 대한 잠재 인수의 모양(Shape)을 다음과 같이 정의하자.</p>

<ul>
<li>열(Row)의 길이는 영화의 개수</li>
<li>컬럼(Column)의 길이는 잠재 인수의 개수</li>
</ul>

<p>\(Q = \begin{bmatrix}
q_{00} &amp; q_{01} \\
q_{10} &amp; q_{11} \\
q_{20} &amp; q_{21} \\
q_{30} &amp; q_{31} \\
q_{40} &amp; q_{41}
\end{bmatrix} \)</p>

<p>사용자(<code>user</code>)에 대한 잠재 인수의 모양(Shape)을 다음과 같이 정의하자.</p>

<ul>
<li>열(Row)의 길이는 사용자의 수</li>
<li>컬럼(Column)의 길이는 잠재 인수의 개수</li>
</ul>

<p>\(P = \begin{bmatrix}
p_{00} &amp; p_{01} \\
p_{10} &amp; p_{11} \\
p_{20} &amp; p_{21} \\
p_{30} &amp; p_{31}
\end{bmatrix} \)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n_items <span style="color:#f92672">=</span> len(mini_df<span style="color:#f92672">.</span>item<span style="color:#f92672">.</span>unique()) <span style="color:#75715e"># 영화 5편</span>
n_items_latent_factors <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 영화의 잠재 인수 개수</span>

n_users <span style="color:#f92672">=</span> len(mini_df<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>unique()) <span style="color:#75715e"># 사용자 4명 </span>
n_users_latent_factors <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 사용자의 잠재 인수 개수</span>

<span style="color:#75715e"># Item latent factor</span>
item_embedding <span style="color:#f92672">=</span> Embedding(n_items, n_items_latent_factors, <span style="color:#75715e"># (5X2) Latent factor</span>
                           embeddings_regularizer<span style="color:#f92672">=</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>),
                           name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;item_embedding&#39;</span>)(item_input)
<span style="color:#75715e"># User latent factor</span>
user_embedding <span style="color:#f92672">=</span> Embedding(n_users, n_users_latent_factors, <span style="color:#75715e"># (4X2) Latent factor</span>
                           embeddings_regularizer<span style="color:#f92672">=</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>),
                           name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user_embedding&#39;</span>)(user_input)</code></pre></div>
<pre><code>WARNING: Logging before flag parsing goes to stderr.
W0914 23:06:25.672605 139764579673920 deprecation.py:506] From /home/dataman/anaconda3/lib/python3.7/site-packages/tensorflow/python/keras/initializers.py:119: calling RandomUniform.__init__ (from tensorflow.python.ops.init_ops) with dtype is deprecated and will be removed in a future version.
Instructions for updating:
Call initializer instance with the dtype argument instead of passing it to the constructor
</code></pre>

<h4 id="벡터화-flattern">벡터화 (Flattern)</h4>

<p>2D로 되어 있는 임베딩(Embedding)을 1D로 변환한다.  이것을 <strong>잠재 벡터(Latent vector)</strong> 라고 한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Item latent vector</span>
item_vec <span style="color:#f92672">=</span> Flatten()(item_embedding)
<span style="color:#75715e"># User latent vector</span>
user_vec <span style="color:#f92672">=</span> Flatten()(user_embedding)</code></pre></div>
<h4 id="미니-모델링-modeling">미니 모델링 (Modeling)</h4>

<ul>
<li>\(\hat R = Q \cdot P^T\)</li>
</ul>

<p>손실 함수(Loss function)는 평균 제곱 오차(mean-squared error)를 사용한다.<br />
최적화(Optimizer)는 경사하강법(gradient descent)을 사용한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">r_hat <span style="color:#f92672">=</span> dot([item_vec, user_vec], axes<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
mini_model <span style="color:#f92672">=</span> Model([user_input, item_input], r_hat)
mini_model<span style="color:#f92672">.</span>compile(optimizer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sgd&#39;</span>, loss <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mean_squared_error&#39;</span>)</code></pre></div>
<h4 id="미니-모델-훈련-train-model">미니 모델 훈련 (Train Model)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hist <span style="color:#f92672">=</span> mini_model<span style="color:#f92672">.</span>fit([mini_df<span style="color:#f92672">.</span>user, mini_df<span style="color:#f92672">.</span>item], mini_df<span style="color:#f92672">.</span>rating, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">2000</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>) 
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;loss: &#39;</span>, hist<span style="color:#f92672">.</span>history[<span style="color:#e6db74">&#39;loss&#39;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])

<span style="color:#f92672">%</span>matplotlib inline
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

plt<span style="color:#f92672">.</span>plot(hist<span style="color:#f92672">.</span>history[<span style="color:#e6db74">&#39;loss&#39;</span>])
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;epoch&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;loss&#39;</span>)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
<pre><code>loss:  0.07310417294502258
</code></pre>

<p><img src="output_50_1.png" alt="png" /></p>

<h4 id="미니-예측-predict">미니 예측 (Predict)</h4>

<p>이제 빵꾸난 별점을 예측해 보자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Q <span style="color:#f92672">=</span> mini_model<span style="color:#f92672">.</span>get_layer(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;item_embedding&#39;</span>)<span style="color:#f92672">.</span>get_weights()[<span style="color:#ae81ff">0</span>]
P <span style="color:#f92672">=</span> mini_model<span style="color:#f92672">.</span>get_layer(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user_embedding&#39;</span>)<span style="color:#f92672">.</span>get_weights()[<span style="color:#ae81ff">0</span>]
P_t <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>transpose(P)

R_hat <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(Q, P_t)
pd<span style="color:#f92672">.</span>DataFrame(R_hat)</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.986020</td>
      <td>4.506338</td>
      <td>1.004396</td>
      <td>0.993599</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4.735092</td>
      <td>4.280501</td>
      <td>1.003393</td>
      <td>0.988274</td>
    </tr>
    <tr>
      <td>2</td>
      <td>5.230458</td>
      <td>4.726562</td>
      <td>1.017328</td>
      <td>1.009568</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.002702</td>
      <td>1.002625</td>
      <td>5.225470</td>
      <td>4.729930</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.001995</td>
      <td>0.992466</td>
      <td>4.729147</td>
      <td>4.282340</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;뷰티 인사이드에 대한 Bob의 예상 별점은 {:.1f}&#39;</span><span style="color:#f92672">.</span>format(R_hat[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;러브 스토리에 대한 Carol의 예상 별점은 {:.1f} 이다.&#39;</span><span style="color:#f92672">.</span>format(R_hat[<span style="color:#ae81ff">2</span>][<span style="color:#ae81ff">2</span>]))</code></pre></div>
<pre><code>뷰티 인사이드에 대한 Bob의 예상 별점은 4.5
러브 스토리에 대한 Carol의 예상 별점은 1.0 이다.
</code></pre>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>실제 값과 가깝게 예측을 하고 있다!</p>
</blockquote>

<h2 id="잠재-인수-모델링-latent-factor-modeling">잠재 인수 모델링 (Latent Factor Modeling)</h2>

<p>알고 있는 데이터세트(\(X, Y\))를 학습하여 새로운 입력값(\(X_{new}\))에 대해 출력값(\(\hat Y\))을 예측하는 모델이 선형 회귀 모델이다. 잠재 인수 모델도 선형 회귀 모델과 비슷하게 손실함수를 정의하고 손실함수가 최소가 되는 \(P\)와 \(Q\)를 찾는 모델이다.</p>

<h3 id="손실함수-loss-function">손실함수 (Loss function)</h3>

<p>잠재 인수 모델(Latent factor model)에서의 손실 함수(Loss function)는 <strong>SSE(Sum of Squared Error)</strong> 를 사용한다.</p>

<p>\(J(p, q) = {1 \over 2}\sum_{(i,j) \in R} (r_{ij} - q_i \cdot p_{j}^T)^2\)</p>

<p>여기에 과대적합(Overfitting)을 방지하기 위해서 <strong>L2 Regularization</strong> 을 추가한다.</p>

<p>\(\begin{align}
J(p, q) &amp; = {1 \over 2}\sum_{(i,j) \in R} (r_{ij} - q_i \cdot p_{j}^T)^2 \\
 &amp; + {1 \over 2}\lambda \sum_{i} ||q_i||^2 + {1 \over 2}\lambda \sum_{j} ||p_j||^2
\end{align}\)</p>

<h3 id="최적화-optimization">최적화 (Optimization)</h3>

<p>손실함수의 최소값을 찾기 위해서 <strong>경사 하강법(Gradient Descent)</strong> 을 적용한다.</p>

<p>REPEAT(epoch) {</p>

<p>\(\begin{align}
p: &amp;= p-\alpha \dfrac{\partial J(p,q)}{\partial p} \\
q: &amp;= q-\alpha \dfrac{\partial J(p,q)}{\partial q}
\end{align}\)<br />
}</p>

<p>\(\alpha\): learining rate</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>여기서는<br />
SSE 대신에 MSE를<br />
GD 대신에 Adam을 사용한다.</p>
</blockquote>

<h3 id="정리">정리</h3>

<p>잠재 인수 모델 (Latent factor model)을 만드는 방법을 정리해 보자.</p>

<ol>
<li>Item, User 값을 인덱스 값으로 변환한다.<br /></li>
<li>잠재 인수(Latent factor)의 개수를 정한다.<br /></li>
<li>잠재 인수(Latent factor)를 <strong>임베딩(Embedding)</strong> 한다.<br /></li>
<li><strong>벡터화(Flatten)</strong> 해서 잠재 벡터(Latent vector)로 변환한다.<br /></li>
<li>\(\hat R\)를 Item과 User의 잠재 벡터의 <strong>내적(dot)</strong> 으로 설정한다.<br /></li>
<li>손실 함수 (Loss function)를 정의한다. 여기서는 <strong>평균 제곱 오차(mean squared error)</strong> 를 사용한다.<br /></li>
<li>옵티마이저(Optimizer)를 정의한다. 여기서는 <strong>Adam</strong> 을 사용한다.<br /></li>
<li>반복할 회수(epoch)를 결정한다.<br /></li>
<li>주어진 조건으로 모델을 최적화(fit) 시킨다.<br /></li>
</ol>

<h2 id="케라스-keras-로-모델링-modeling">케라스(Keras)로 모델링(Modeling)</h2>

<h3 id="데이터-변환">데이터 변환</h3>

<p><code>userId</code>와 <code>movieId</code>를 숫자로 변환(인코딩)한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Indexing userId and movieId</span>
users <span style="color:#f92672">=</span> ratings_df<span style="color:#f92672">.</span>userId<span style="color:#f92672">.</span>unique()
movies <span style="color:#f92672">=</span> ratings_df<span style="color:#f92672">.</span>movieId<span style="color:#f92672">.</span>unique()

userid2idx <span style="color:#f92672">=</span> {o:i <span style="color:#66d9ef">for</span> i,o <span style="color:#f92672">in</span> enumerate(users)}
movieid2idx <span style="color:#f92672">=</span> {o:i <span style="color:#66d9ef">for</span> i,o <span style="color:#f92672">in</span> enumerate(movies)}

ratings_df[<span style="color:#e6db74">&#39;userId&#39;</span>] <span style="color:#f92672">=</span> ratings_df[<span style="color:#e6db74">&#39;userId&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: userid2idx[x])
ratings_df[<span style="color:#e6db74">&#39;movieId&#39;</span>] <span style="color:#f92672">=</span> ratings_df[<span style="color:#e6db74">&#39;movieId&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: movieid2idx[x])</code></pre></div>
<h3 id="훈련-테스트-데이터-분할">훈련, 테스트 데이터 분할</h3>

<p>훈련 데이터는 <code>ratings_df</code>에서 랜덤하게 80%를 선택하고,<br />
테스트 데이터는 나머지 20%를 랜덤하게 선택한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Split train and test data</span>
split <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(len(ratings_df)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.8</span>

train_df <span style="color:#f92672">=</span> ratings_df[split]
test_df <span style="color:#f92672">=</span> ratings_df[<span style="color:#f92672">~</span>split]

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;shape of train data is &#39;</span>,train_df<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;shape of test data is &#39;</span>,test_df<span style="color:#f92672">.</span>shape)</code></pre></div>
<pre><code>shape of train data is  (80712, 4)
shape of test data is  (20124, 4)
</code></pre>

<h3 id="임베딩-embedding-1">임베딩 (Embedding)</h3>

<p>잠재 인수 개수를 64개로 하자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n_movies <span style="color:#f92672">=</span> len(ratings_df<span style="color:#f92672">.</span>movieId<span style="color:#f92672">.</span>unique())
n_users <span style="color:#f92672">=</span> len(ratings_df<span style="color:#f92672">.</span>userId<span style="color:#f92672">.</span>unique())
n_latent_factors <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>

movie_input <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>])
<span style="color:#75715e"># Item latent factor</span>
movie_embedding <span style="color:#f92672">=</span> Embedding(n_movies, n_latent_factors,
                            embeddings_regularizer<span style="color:#f92672">=</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.00001</span>), 
                            name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;movie_embedding&#39;</span>)(movie_input)

user_input <span style="color:#f92672">=</span> Input(shape<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>])
<span style="color:#75715e"># User latent factor</span>
user_embedding <span style="color:#f92672">=</span> Embedding(n_users, n_latent_factors,
                           embeddings_regularizer<span style="color:#f92672">=</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.00001</span>),
                           name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user_embedding&#39;</span>)(user_input)</code></pre></div>
<h3 id="벡터화-flatten">벡터화 (Flatten)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Item latent vector</span>
movie_vec <span style="color:#f92672">=</span> Flatten()(movie_embedding)
<span style="color:#75715e"># User latent vector</span>
user_vec <span style="color:#f92672">=</span> Flatten()(user_embedding)</code></pre></div>
<h3 id="모델링-modeling">모델링 (Modeling)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">r_hat <span style="color:#f92672">=</span> dot([movie_vec, user_vec], axes<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
model <span style="color:#f92672">=</span> Model([user_input, movie_input], r_hat)
model<span style="color:#f92672">.</span>compile(optimizer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adam&#39;</span>, loss <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mean_squared_error&#39;</span>)</code></pre></div>
<h3 id="모델-훈련-train-model">모델 훈련 (Train Model)</h3>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>돌려놓고 커피 한잔 하세여~ ☕️</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hist <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit([train_df<span style="color:#f92672">.</span>userId, train_df<span style="color:#f92672">.</span>movieId], train_df<span style="color:#f92672">.</span>rating, 
                 batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ) 

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;train loss: &#39;</span>, hist<span style="color:#f92672">.</span>history[<span style="color:#e6db74">&#39;loss&#39;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])

<span style="color:#f92672">%</span>matplotlib inline
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

plt<span style="color:#f92672">.</span>plot(hist<span style="color:#f92672">.</span>history[<span style="color:#e6db74">&#39;loss&#39;</span>])
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;epoch&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;loss&#39;</span>)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
<pre><code>train loss:  0.22794349201962194
</code></pre>

<p><img src="output_67_1.png" alt="png" /></p>

<h3 id="모델-평가-test-model">모델 평가 (Test Model)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_loss <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>evaluate([test_df<span style="color:#f92672">.</span>userId, test_df<span style="color:#f92672">.</span>movieId], test_df<span style="color:#f92672">.</span>rating)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;test loss: &#39;</span>, test_loss)</code></pre></div>
<pre><code>20124/20124 [==============================] - 1s 32us/sample - loss: 1.8129
test loss:  1.8128546826812435
</code></pre>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>음&hellip;<br />
개선 사항이 보이지만<br />
오늘은 여기까지 하자</p>
</blockquote>

<h2 id="해결-solution">해결 (Solution)</h2>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>보스~ 원하시는 솔루션입니다.</p>

<p>userId, movieId 값을 입력하시면<br />
예상되는 별점값이 출력 됩니다.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">userId <span style="color:#f92672">=</span> <span style="color:#ae81ff">214</span>       <span style="color:#75715e"># 1 ~ 610</span>
movieId <span style="color:#f92672">=</span> <span style="color:#ae81ff">1059</span>  <span style="color:#75715e"># 1 ~ 193609</span>
movie_title <span style="color:#f92672">=</span> list(movies_df[movies_df[<span style="color:#e6db74">&#39;movieId&#39;</span>]<span style="color:#f92672">==</span>movieId]<span style="color:#f92672">.</span>title)[<span style="color:#ae81ff">0</span>]

user_v <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(userid2idx[userId], <span style="color:#ae81ff">0</span>)
movie_v <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(movieid2idx[movieId], <span style="color:#ae81ff">0</span>)
predict <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict([user_v, movie_v])

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;영화 {} 에 대한 사용자 ID {}님의 예상 별점은 {:.1f} 입니다.&#39;</span><span style="color:#f92672">.</span>format(movie_title, userId, predict[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]))</code></pre></div>
<pre><code>영화 William Shakespeare's Romeo + Juliet (1996) 에 대한 사용자 ID 214님의 예상 별점은 3.8 입니다.
</code></pre>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/latent-factor/" rel="tag">Latent factor</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/matrix-factorization/" rel="tag">Matrix Factorization</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/embedding/" rel="tag">Embedding</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/convolutional_neural_network/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Convolutional Neural Network</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/recurrent_neural_network/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Recurrent Neural Network</p></a>
	</div>
</nav>
<script src="https://utteranc.es/client.js"
        repo="skettee/blog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 skettee.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>
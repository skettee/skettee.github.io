<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Long Short-Term Memory (LSTM) - 막돼먹은 엔지니어의 머신런닝 개발</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Long Short-Term Memory (LSTM)" />
<meta property="og:description" content="감성 분석(Sentiment Analysis)을 위해서 텍스트 데이터를 변환하는 방법과 LSTM에 대해 알아보고 keras를 이용해서 모델링을 해보자!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/long_short_term_memory/" />
<meta property="article:published_time" content="2019-09-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-14T00:00:00+00:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="막돼먹은 엔지니어의 머신런닝 개발" rel="home">
				<div class="logo__title">막돼먹은 엔지니어의 머신런닝 개발</div>
				<div class="logo__tagline">딥러닝 모델링</div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Long Short-Term Memory (LSTM)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-09-14T00:00:00">2019-09-14</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/deep-learning" rel="category">Deep Learning</a>, <a class="meta__link" href="/categories/recurrent-neural-network" rel="category">Recurrent Neural Network</a></span>
</div>
</div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#문제-problem">문제 (Problem)</a></li>
<li><a href="#데이터-수집-data-collection">데이터 수집 (Data Collection)</a>
<ul>
<li><a href="#rating-데이터-프레임">Rating 데이터 프레임</a></li>
</ul></li>
<li><a href="#데이터-분석-data-analysis">데이터 분석 (Data Analysis)</a></li>
<li><a href="#데이터-전처리-data-preprocessing">데이터 전처리 (Data Preprocessing)</a>
<ul>
<li><a href="#형태소-분석기-설치">형태소 분석기 설치</a></li>
<li><a href="#토큰화-tokenization">토큰화 (Tokenization)</a>
<ul>
<li><a href="#품사-part-of-speech">품사 (Part Of Speech)</a></li>
<li><a href="#불용어-stop-words">불용어 (Stop Words)</a></li>
<li><a href="#어간-원형-복원-lemmatization">어간 원형 복원 (Lemmatization)</a></li>
</ul></li>
</ul></li>
<li><a href="#lstm-모델링-lstm-modeling">LSTM 모델링 (LSTM Modeling)</a>
<ul>
<li><a href="#lstm-long-short-term-memory">LSTM (Long Short-Term Memory)</a></li>
<li><a href="#many-to-one-model">Many-to-One Model</a></li>
<li><a href="#정리">정리</a></li>
</ul></li>
<li><a href="#케라스-keras-로-모델링-modeling">케라스(Keras)로 모델링(Modeling)</a>
<ul>
<li><a href="#데이터-변환-data-transformation">데이터 변환 (Data Transformation)</a>
<ul>
<li><a href="#encoding">Encoding</a></li>
<li><a href="#padding">Padding</a></li>
<li><a href="#이진-분류-binary-classification">이진 분류 (Binary classification)</a></li>
</ul></li>
<li><a href="#모델링-modeling">모델링 (Modeling)</a></li>
<li><a href="#모델-훈련-train-model">모델 훈련 (Train Model)</a></li>
<li><a href="#모델-테스트-test-model">모델 테스트 (Test Model)</a></li>
<li><a href="#모델-저장-save-model">모델 저장 (Save Model)</a></li>
</ul></li>
<li><a href="#해결-solution">해결 (Solution)</a></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<p>감성 분석(Sentiment Analysis)을 위해서 텍스트 데이터를 변환하는 방법과 LSTM에 대해 알아보고 keras를 이용해서 모델링을 해보자!</p>

<p>실제로 돌려 보고 싶으면 구글 코랩으로 ~</p>

<p><a href="https://colab.research.google.com/github/skettee/notebooks/blob/master/long_short_term_memory.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab" /></a></p>

<h2 id="문제-problem">문제 (Problem)</h2>

<p>👤 상사</p>

<blockquote>
<p>오~ 간단한 감성 분석기를 만들었군<br />
근데 이건 애들 장난이고&hellip;<br />
네이버가 제공하는 영화 리뷰 데이터로<br />
제대로 된 감성 분석기를 만들어 보게<br />
데이터는 아래에 있네</p>

<p><a href="https://github.com/e9t/nsmc">https://github.com/e9t/nsmc</a></p>
</blockquote>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>프로젝트가 쌓여만 간다&hellip;<br />
이제<br />
떠날 때가 된것인가&hellip;</p>
</blockquote>

<h2 id="데이터-수집-data-collection">데이터 수집 (Data Collection)</h2>

<p><a href="https://github.com/e9t/nsmc">https://github.com/e9t/nsmc</a> 에서 데이터 정보를 알아보자</p>

<p><strong>Data description</strong>
- Each file is consisted of three columns: id, document, label
    - id: The review id, provieded by Naver
    - document: The actual review
    - label: The sentiment class of the review. (0: negative, 1: positive)
    - Columns are delimited with tabs (i.e., .tsv format; but the file extension is .txt for easy access for novices)
- 200K reviews in total
    - ratings.txt: All 200K reviews
    - ratings_test.txt: 50K reviews held out for testing
    - ratings_train.txt: 150K reviews for training</p>

<p><strong>Characteristics</strong>
- All reviews are shorter than 140 characters
- Each sentiment class is sampled equally (i.e., random guess yields 50% accuracy)
    - 100K negative reviews (originally reviews of ratings 1-4)
    -100K positive reviews (originally reviews of ratings 9-10)
    - Neutral reviews (originally reviews of ratings 5-8) are excluded</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>ratings_test.txt, ratings_train.txt를 다운로드 하자</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras.utils <span style="color:#f92672">import</span> get_file

train_fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ratings_train.tsv&#39;</span>
test_fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ratings_test.tsv&#39;</span>
train_origin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://raw.github.com/e9t/nsmc/master/ratings_train.txt&#39;</span>
test_origin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://raw.github.com/e9t/nsmc/master/ratings_test.txt&#39;</span>

train_path <span style="color:#f92672">=</span> get_file(train_fname, train_origin)
test_path <span style="color:#f92672">=</span> get_file(test_fname, test_origin)</code></pre></div>
<h3 id="rating-데이터-프레임">Rating 데이터 프레임</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

train_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(train_path, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># tsv file</span>
train_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>document</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>9976970</td>
      <td>아 더빙.. 진짜 짜증나네요 목소리</td>
      <td>0</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3819312</td>
      <td>흠...포스터보고 초딩영화줄....오버연기조차 가볍지 않구나</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>10265843</td>
      <td>너무재밓었다그래서보는것을추천한다</td>
      <td>0</td>
    </tr>
    <tr>
      <td>3</td>
      <td>9045019</td>
      <td>교도소 이야기구먼 ..솔직히 재미는 없다..평점 조정</td>
      <td>0</td>
    </tr>
    <tr>
      <td>4</td>
      <td>6483659</td>
      <td>사이몬페그의 익살스런 연기가 돋보였던 영화!스파이더맨에서 늙어보이기만 했던 커스틴 ...</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(test_path, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># tsv file</span>
test_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>document</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>6270596</td>
      <td>굳 ㅋ</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>9274899</td>
      <td>GDNTOPCLASSINTHECLUB</td>
      <td>0</td>
    </tr>
    <tr>
      <td>2</td>
      <td>8544678</td>
      <td>뭐야 이 평점들은.... 나쁘진 않지만 10점 짜리는 더더욱 아니잖아</td>
      <td>0</td>
    </tr>
    <tr>
      <td>3</td>
      <td>6825595</td>
      <td>지루하지는 않은데 완전 막장임... 돈주고 보기에는....</td>
      <td>0</td>
    </tr>
    <tr>
      <td>4</td>
      <td>6723715</td>
      <td>3D만 아니었어도 별 다섯 개 줬을텐데.. 왜 3D로 나와서 제 심기를 불편하게 하죠??</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="데이터-분석-data-analysis">데이터 분석 (Data Analysis)</h2>

<p>빵꾸난거 부터 확인하고 제거하자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_df<span style="color:#f92672">.</span>isnull()<span style="color:#f92672">.</span>any()</code></pre></div>
<pre><code>id          False
document     True
label       False
dtype: bool
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_df <span style="color:#f92672">=</span> train_df<span style="color:#f92672">.</span>dropna(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_df<span style="color:#f92672">.</span>isnull()<span style="color:#f92672">.</span>any()</code></pre></div>
<pre><code>id          False
document     True
label       False
dtype: bool
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_df <span style="color:#f92672">=</span> test_df<span style="color:#f92672">.</span>dropna(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)</code></pre></div>
<p>데이터의 크기와 레이블에 따른 분포를 확인하자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Train data shape: &#39;</span>, train_df<span style="color:#f92672">.</span>shape)
n_lebel <span style="color:#f92672">=</span> len(train_df[train_df<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Label 0 in Train data: {} ({:.1f}%)&#39;</span><span style="color:#f92672">.</span>format(n_lebel, n_lebel<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>len(train_df)))
n_lebel <span style="color:#f92672">=</span> len(train_df[train_df<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Label 1 in Train data: {} ({:.1f}%)&#39;</span><span style="color:#f92672">.</span>format(n_lebel, n_lebel<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>len(train_df)))

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Test data shape: &#39;</span>, test_df<span style="color:#f92672">.</span>shape)
n_lebel <span style="color:#f92672">=</span> len(test_df[test_df<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Label 0 in Test data: {} ({:.1f}%)&#39;</span><span style="color:#f92672">.</span>format(n_lebel, n_lebel<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>len(test_df)))
n_lebel <span style="color:#f92672">=</span> len(test_df[test_df<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Label 1 in Test data: {} ({:.1f}%)&#39;</span><span style="color:#f92672">.</span>format(n_lebel, n_lebel<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">/</span>len(test_df)))</code></pre></div>
<pre><code>Train data shape:  (149995, 3)
Label 0 in Train data: 75170 (50.1%)
Label 1 in Train data: 74825 (49.9%)

Test data shape:  (49997, 3)
Label 0 in Test data: 24826 (49.7%)
Label 1 in Test data: 25171 (50.3%)
</code></pre>

<p><code>id</code>컬럼은 필요 없으니 제거하자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_df <span style="color:#f92672">=</span> train_df[[<span style="color:#e6db74">&#39;document&#39;</span>, <span style="color:#e6db74">&#39;label&#39;</span>]]
test_df <span style="color:#f92672">=</span> test_df[[<span style="color:#e6db74">&#39;document&#39;</span>, <span style="color:#e6db74">&#39;label&#39;</span>]]</code></pre></div>
<h2 id="데이터-전처리-data-preprocessing">데이터 전처리 (Data Preprocessing)</h2>

<p>한글 텍스트를 RNN에 입력하기 위해서는 텍스트를 RNN이 처리하기 편한 형태로 분리해야 한다. 이렇게 텍스트를 분리하는 작업을 <strong>토근화(Tokenization)</strong> 라고 한다.<br />
한글을 토큰화 하기 위해서 형태소 분석기를 사용한다. 다양한 한글 형태소 분석기가 존재하는데, 여기에서는 PyKomoran을 사용한다. 다른 형태소 분석기에 관심이 있으면 아래를 참조한다.</p>

<ul>
<li><a href="https://bitbucket.org/eunjeon/mecab-ko-dic/src/master/">Mecap</a></li>
<li><a href="https://github.com/kakao/khaiii">Khaiii</a></li>
<li><a href="https://github.com/shin285/KOMORAN">Komoran</a></li>
</ul>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>앞에서 본 이모티콘 감성분석에서<br />
이모티콘을 텍스트로 변환했는데<br />
반대로<br />
텍스트를 이모티콘으로 변환하는 것을<br />
토큰화(Tokenization)라고 생각하면<br />
이해가 쉬울 것 같다&hellip;</p>
</blockquote>

<h3 id="형태소-분석기-설치">형태소 분석기 설치</h3>

<p>PyKomoran을 사용하기 위해서는 Java가 설치 되어 있어야 한다. 아래 명령어를 실행해서 Java가 설치되어 있는지 확인하자.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">!</span>java <span style="color:#f92672">-</span>version</code></pre></div>
<pre><code>openjdk version &quot;1.8.0_152-release&quot;
OpenJDK Runtime Environment (build 1.8.0_152-release-1056-b12)
OpenJDK 64-Bit Server VM (build 25.152-b12, mixed mode)
</code></pre>

<p>PyKomoran을 설치한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span>pip install PyKomoran</code></pre></div>
<pre><code>Collecting PyKomoran
[?25l  Downloading https://files.pythonhosted.org/packages/23/b0/ce6a46f311651ed64c39beb1cfe1c39a9906521139ace45430d08c489b62/PyKomoran-0.1.5-py3-none-any.whl (7.9MB)
[K     |████████████████████████████████| 7.9MB 1.2MB/s eta 0:00:01
[?25hCollecting py4j==0.10.8.1 (from PyKomoran)
[?25l  Downloading https://files.pythonhosted.org/packages/04/de/2d314a921ef4c20b283e1de94e0780273678caac901564df06b948e4ba9b/py4j-0.10.8.1-py2.py3-none-any.whl (196kB)
[K     |████████████████████████████████| 204kB 2.1MB/s eta 0:00:01
[?25hInstalling collected packages: py4j, PyKomoran
Successfully installed PyKomoran-0.1.5 py4j-0.10.8.1
Note: you may need to restart the kernel to use updated packages.
</code></pre>

<p>설치 확인을 위해 아래 코드를 실행한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> PyKomoran <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

corpus <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;① 대한민국은 민주공화국이다.&#34;</span>
komoran <span style="color:#f92672">=</span> Komoran(<span style="color:#e6db74">&#34;STABLE&#34;</span>)
komoran<span style="color:#f92672">.</span>get_plain_text(corpus)</code></pre></div>
<pre><code>'①/SW 대한민국/NNP 은/JX 민주/NNP 공화국/NNG 이/VCP 다/EF ./SF'
</code></pre>

<h3 id="토큰화-tokenization">토큰화 (Tokenization)</h3>

<p>형태소 분석기는 문장을 품사(PoS)별로 분리해 준다. 모든 품사를 사용하지 않고 감성 분석에 필요하다고 판단이 되는 품사를 선정해서 토큰화를 진행한다.</p>

<h4 id="품사-part-of-speech">품사 (Part Of Speech)</h4>

<p>Komoran에서 정의하는 품사 종류는 아래 사이트를 참조.<br />
품사표 (PoS Table): <a href="https://pydocs.komoran.kr/firststep/postypes.html">https://pydocs.komoran.kr/firststep/postypes.html</a></p>

<h4 id="불용어-stop-words">불용어 (Stop Words)</h4>

<p>RNN에 입력으로 들어가지 못하는 단어들을 말한다. 여기서는 들어가지 못하는 품사를 아래와 같이 정의한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">stop_pos_tags <span style="color:#f92672">=</span>  [<span style="color:#e6db74">&#39;IC&#39;</span>, <span style="color:#e6db74">&#39;JKS&#39;</span>, <span style="color:#e6db74">&#39;JKC&#39;</span>, <span style="color:#e6db74">&#39;JKG&#39;</span>, <span style="color:#e6db74">&#39;JKO&#39;</span>, <span style="color:#e6db74">&#39;JKB&#39;</span>, <span style="color:#e6db74">&#39;JKV&#39;</span>, <span style="color:#e6db74">&#39;JKQ&#39;</span>, <span style="color:#e6db74">&#39;JX&#39;</span>, 
                   <span style="color:#e6db74">&#39;EF&#39;</span>, <span style="color:#e6db74">&#39;ETN&#39;</span>, <span style="color:#e6db74">&#39;ETM&#39;</span>, <span style="color:#e6db74">&#39;XSA&#39;</span>, <span style="color:#e6db74">&#39;SF&#39;</span>, <span style="color:#e6db74">&#39;SP&#39;</span>, <span style="color:#e6db74">&#39;SS&#39;</span>, <span style="color:#e6db74">&#39;SE&#39;</span>, <span style="color:#e6db74">&#39;SO&#39;</span>, <span style="color:#e6db74">&#39;SL&#39;</span>, <span style="color:#e6db74">&#39;SH&#39;</span>, 
                   <span style="color:#e6db74">&#39;SW&#39;</span>, <span style="color:#e6db74">&#39;NF&#39;</span>, <span style="color:#e6db74">&#39;NV&#39;</span>, <span style="color:#e6db74">&#39;SN&#39;</span>, <span style="color:#e6db74">&#39;NA&#39;</span>]</code></pre></div>
<h4 id="어간-원형-복원-lemmatization">어간 원형 복원 (Lemmatization)</h4>

<p>동사와 형용사의 경우에는 어간(Stem)에 &lsquo;다&rsquo;를 붙여서 기본형으로 복원한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tokenize</span>(corpus, stop_pos_tags):
    result <span style="color:#f92672">=</span> []
    pairs <span style="color:#f92672">=</span> komoran<span style="color:#f92672">.</span>get_list(corpus)
    <span style="color:#66d9ef">for</span> pair <span style="color:#f92672">in</span> pairs:
        morph <span style="color:#f92672">=</span> pair<span style="color:#f92672">.</span>get_first()
        pos <span style="color:#f92672">=</span> pair<span style="color:#f92672">.</span>get_second()
        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> stop_pos_tags:
            <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;VV&#39;</span>, <span style="color:#e6db74">&#39;VA&#39;</span>, <span style="color:#e6db74">&#39;VX&#39;</span>, <span style="color:#e6db74">&#39;VCP&#39;</span>, <span style="color:#e6db74">&#39;VCN&#39;</span>]:
                morph <span style="color:#f92672">=</span> morph <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;다&#39;</span>
            result<span style="color:#f92672">.</span>append(morph)
    <span style="color:#66d9ef">return</span> result</code></pre></div>
<p>토큰을 만들고 리스트에 저장한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tokens_list <span style="color:#f92672">=</span> []

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(train_df[<span style="color:#e6db74">&#39;document&#39;</span>])):
    tokens_list<span style="color:#f92672">.</span>append(tokenize(train_df[<span style="color:#e6db74">&#39;document&#39;</span>][i], stop_pos_tags))</code></pre></div>
<p>데이터 프레임에 넣어서 토큰이 제대로 만들어 졌는지 확인한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_df[<span style="color:#e6db74">&#39;tokens&#39;</span>] <span style="color:#f92672">=</span> tokens_list

train_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document</th>
      <th>label</th>
      <th>tokens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>아 더빙.. 진짜 짜증나네요 목소리</td>
      <td>0</td>
      <td>[더빙, 진짜, 짜증, 나다, 네요, 목소리]</td>
    </tr>
    <tr>
      <td>1</td>
      <td>흠...포스터보고 초딩영화줄....오버연기조차 가볍지 않구나</td>
      <td>1</td>
      <td>[포스터, 초, 딩, 영화, 줄, 오버, 연기, 가볍다, 지, 않다, 구나]</td>
    </tr>
    <tr>
      <td>2</td>
      <td>너무재밓었다그래서보는것을추천한다</td>
      <td>0</td>
      <td>[]</td>
    </tr>
    <tr>
      <td>3</td>
      <td>교도소 이야기구먼 ..솔직히 재미는 없다..평점 조정</td>
      <td>0</td>
      <td>[교도소, 이야기, 이다, 구먼, 솔직히, 재미, 없다, 평점, 조정]</td>
    </tr>
    <tr>
      <td>4</td>
      <td>사이몬페그의 익살스런 연기가 돋보였던 영화!스파이더맨에서 늙어보이기만 했던 커스틴 ...</td>
      <td>1</td>
      <td>[익살, 연기, 돋보이다, 었, 영화, 스파이, 더, 맨, 늙다, 어, 보이다, 하...</td>
    </tr>
  </tbody>
</table>
</div>

<p>토큰이 비어있는 열은 과감하게 제거한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_df <span style="color:#f92672">=</span> train_df[train_df[<span style="color:#e6db74">&#39;tokens&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>len() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>]</code></pre></div>
<p>테스트 데이터도 동일하게 토큰을 추출하고 데이터프레임에 저장한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tokens_list <span style="color:#f92672">=</span> []

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(test_df[<span style="color:#e6db74">&#39;document&#39;</span>])):
    tokens_list<span style="color:#f92672">.</span>append(tokenize(test_df[<span style="color:#e6db74">&#39;document&#39;</span>][i], stop_pos_tags))
test_df[<span style="color:#e6db74">&#39;tokens&#39;</span>] <span style="color:#f92672">=</span> tokens_list

test_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document</th>
      <th>label</th>
      <th>tokens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>굳 ㅋ</td>
      <td>1</td>
      <td>[굳다]</td>
    </tr>
    <tr>
      <td>1</td>
      <td>GDNTOPCLASSINTHECLUB</td>
      <td>0</td>
      <td>[]</td>
    </tr>
    <tr>
      <td>2</td>
      <td>뭐야 이 평점들은.... 나쁘진 않지만 10점 짜리는 더더욱 아니잖아</td>
      <td>0</td>
      <td>[뭐, 이, 평점, 들, 나쁘다, 지, 않다, 지만, 점, 짜리, 더더욱, 아니다,...</td>
    </tr>
    <tr>
      <td>3</td>
      <td>지루하지는 않은데 완전 막장임... 돈주고 보기에는....</td>
      <td>0</td>
      <td>[지루, 지, 않다, 은데, 완전, 막장, 이다, 돈, 주다, 고, 보다]</td>
    </tr>
    <tr>
      <td>4</td>
      <td>3D만 아니었어도 별 다섯 개 줬을텐데.. 왜 3D로 나와서 제 심기를 불편하게 하죠??</td>
      <td>0</td>
      <td>[아니다, 었, 어도, 별, 다섯, 개, 주다, 었, 텐, 데, 왜, 나오다, 아서...</td>
    </tr>
  </tbody>
</table>
</div>

<p>토큰이 비어있는 열은 과감하게 제거한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_df <span style="color:#f92672">=</span> test_df[test_df[<span style="color:#e6db74">&#39;tokens&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>len() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>]</code></pre></div>
<h2 id="lstm-모델링-lstm-modeling">LSTM 모델링 (LSTM Modeling)</h2>

<p>RNN의 단점은 timestep이 증가하면 이전의 입력 데이터 정보가 사라진다는 것이다. 긴 문장의 경우에 timestep이 수백개가 되는 경우가 있다. 즉 RNN 레이어가 수백개가 되면 손실함수의 최소값을 찾기 위해 미분의 미분의 &hellip; 미분을 수백번을 하게 되고 어느 지점 부터 미분값이 0이 되면 그 이전의 입력 데이터 정보는 사용할 수 없게 된다.</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>RNN이 알고보니<br />
&lsquo;메멘토&rsquo; 였다!</p>

<p>그러나 엔지니어를 또 갈아서 해결했다.<br />
그것은 바로&hellip;</p>
</blockquote>

<h3 id="lstm-long-short-term-memory">LSTM (Long Short-Term Memory)</h3>

<p>RNN unit에 이전 데이터의 정보를 저장하고 있는 메모리 셀(memory cell) 함수(\(c^{\lt t \gt}\))와 메모리 셀을 유지할 것인지 업데이트 할 것인지를 결정하는 게이트(gate) 함수(\(\Gamma_u, \Gamma_f, \Gamma_o\))를 추가한 것이 LSTM이다.</p>

<p><img src="https://skettee.github.io/post/long_short_term_memory/lstm.png" alt="LSTM Unit" /></p>

<p>\(\begin{align}
\tilde c^{\lt t \gt} &amp; = tanh\left(W_{ca}a^{\lt t-1 \gt} + W_{cx}x^{\lt t \gt} + b_c\right) \\
\Gamma_u &amp; = \sigma \left( W_{ua}a^{\lt t-1 \gt} + W_{ux}x^{\lt t \gt} + b_u \right) \\
\Gamma_f &amp; = \sigma \left( W_{fa}a^{\lt t-1 \gt} + W_{fx}x^{\lt t \gt} + b_f \right) \\
\Gamma_o &amp; = \sigma \left( W_{oa}a^{\lt t-1 \gt} + W_{ox}x^{\lt t \gt} + b_o \right) \\
c^{\lt t \gt} &amp; = \Gamma_u * \tilde c^{\lt t \gt} + \Gamma_f * c^{\lt t-1 \gt} \\
a^{\lt t \gt} &amp; = \Gamma_o * tanh (c^{\lt t \gt}) \\
\hat y^{\lt t \gt} &amp; = W_{ya}a^{\lt t \gt} + b_y
\end{align}\)</p>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>게이트(\(\Gamma\))의 열고(\(\Gamma = 1\)) 닫고(\(\Gamma = 0\))를<br />
학습에 의해서 결정 (\((W_u, b_u), (W_f, b_f), (W_o, b_o)\)) 한다.<br />
게이트(\(\Gamma\))의 상태에 따라서<br />
메모리 셀 (\(c^{\lt t \gt}\))을 업데이트 할건지 (\(\tilde c^{\lt t \gt}\))<br />
이전것을 유지할건지 (\(c^{\lt t-1 \gt}\))
결정한다.</p>

<p>트랜지스터 같네&hellip;</p>
</blockquote>

<h3 id="many-to-one-model">Many-to-One Model</h3>

<p>감성분석(Sentiment Anaysis)에 사용되는 many to one 모델을 사용한다.<br />
훈련 리뷰 개수 136,927개를 사용하고, time step은 40으로 고정한다.<br />
리뷰마다 토큰의 수가 다르므로 40이 안되면 0으로 채우고(padding) 40이 넘으면 그 이상은 잘라 버린다(clipping)</p>

<h3 id="정리">정리</h3>

<ol>
<li>Input Layer

<ol>
<li>Batch size는 136927개<br /></li>
<li>Time step은 40개 (\(T_x = 40\))<br /></li>
<li>Feature 개수는 입력에 들어가는 토큰 1개<br /></li>
</ol></li>
<li>LSTM Layer

<ol>
<li>128개 유닛으로 구성한다.<br /></li>
<li>Dropout을 0.2로 설정한다.<br /></li>
</ol></li>
<li>Output Layer

<ol>
<li>활성 함수는 시그모이드(Sigmoid)를 사용한다.</li>
</ol></li>
<li>Loss funtion 은 binary_crossentropy 를 사용한다.<br /></li>
<li>Optimizer 는 Adam을 사용한다.<br /></li>
</ol>

<h2 id="케라스-keras-로-모델링-modeling">케라스(Keras)로 모델링(Modeling)</h2>

<h3 id="데이터-변환-data-transformation">데이터 변환 (Data Transformation)</h3>

<p>토큰을 숫자로 변환(Encoding)하고, 입력 토큰의 개수를 동일한 크기로 맞춘다. 출력은 0과 1로 변환한다.</p>

<h4 id="encoding">Encoding</h4>

<p>토큰을 숫자로 변환하고 tokenizer를 파일에 저장한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras.preprocessing.text <span style="color:#f92672">import</span> Tokenizer
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pickle

tokenizer_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;keras_naver_review_tokenizer.pickle&#39;</span>
save_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), tokenizer_name)

max_words <span style="color:#f92672">=</span> <span style="color:#ae81ff">35000</span>
tokenizer <span style="color:#f92672">=</span> Tokenizer(num_words<span style="color:#f92672">=</span>max_words, oov_token <span style="color:#f92672">=</span> True)
tokenizer<span style="color:#f92672">.</span>fit_on_texts(train_df<span style="color:#f92672">.</span>tokens)
train_df<span style="color:#f92672">.</span>tokens <span style="color:#f92672">=</span> tokenizer<span style="color:#f92672">.</span>texts_to_sequences(train_df<span style="color:#f92672">.</span>tokens)
test_df<span style="color:#f92672">.</span>tokens <span style="color:#f92672">=</span> tokenizer<span style="color:#f92672">.</span>texts_to_sequences(test_df<span style="color:#f92672">.</span>tokens)

<span style="color:#66d9ef">with</span> open(save_path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
    pickle<span style="color:#f92672">.</span>dump(tokenizer, f, protocol<span style="color:#f92672">=</span>pickle<span style="color:#f92672">.</span>HIGHEST_PROTOCOL)

train_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document</th>
      <th>label</th>
      <th>tokens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>아 더빙.. 진짜 짜증나네요 목소리</td>
      <td>0</td>
      <td>[502, 31, 210, 66, 70, 716]</td>
    </tr>
    <tr>
      <td>1</td>
      <td>흠...포스터보고 초딩영화줄....오버연기조차 가볍지 않구나</td>
      <td>1</td>
      <td>[489, 305, 236, 2, 172, 1294, 42, 717, 16, 34,...</td>
    </tr>
    <tr>
      <td>3</td>
      <td>교도소 이야기구먼 ..솔직히 재미는 없다..평점 조정</td>
      <td>0</td>
      <td>[5551, 138, 3, 3988, 281, 87, 17, 46, 2881]</td>
    </tr>
    <tr>
      <td>4</td>
      <td>사이몬페그의 익살스런 연기가 돋보였던 영화!스파이더맨에서 늙어보이기만 했던 커스틴 ...</td>
      <td>1</td>
      <td>[6734, 42, 845, 10, 2, 1602, 67, 414, 1156, 12...</td>
    </tr>
    <tr>
      <td>5</td>
      <td>막 걸음마 뗀 3세부터 초등학교 1학년생인 8살용영화.ㅋㅋㅋ...별반개도 아까움.</td>
      <td>0</td>
      <td>[678, 13857, 1512, 264, 1678, 1452, 471, 3, 80]</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">test_df<span style="color:#f92672">.</span>head()</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document</th>
      <th>label</th>
      <th>tokens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2</td>
      <td>뭐야 이 평점들은.... 나쁘진 않지만 10점 짜리는 더더욱 아니잖아</td>
      <td>0</td>
      <td>[54, 18, 46, 13, 456, 16, 34, 35, 26, 605, 314...</td>
    </tr>
    <tr>
      <td>3</td>
      <td>지루하지는 않은데 완전 막장임... 돈주고 보기에는....</td>
      <td>0</td>
      <td>[78, 16, 34, 238, 128, 340, 3, 140, 22, 5, 4]</td>
    </tr>
    <tr>
      <td>4</td>
      <td>3D만 아니었어도 별 다섯 개 줬을텐데.. 왜 3D로 나와서 제 심기를 불편하게 하죠??</td>
      <td>0</td>
      <td>[41, 10, 243, 191, 1942, 109, 22, 10, 671, 188...</td>
    </tr>
    <tr>
      <td>5</td>
      <td>음악이 주가 된, 최고의 음악영화</td>
      <td>1</td>
      <td>[216, 3476, 45, 49, 216, 2]</td>
    </tr>
    <tr>
      <td>7</td>
      <td>마치 미국애니에서 튀어나온듯한 창의력없는 로봇디자인부터가,고개를 젖게한다</td>
      <td>0</td>
      <td>[1060, 395, 372, 4329, 282, 11, 6400, 17, 1378...</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">X_train <span style="color:#f92672">=</span> train_df<span style="color:#f92672">.</span>tokens
Y_train <span style="color:#f92672">=</span> train_df<span style="color:#f92672">.</span>label

X_test <span style="color:#f92672">=</span> test_df<span style="color:#f92672">.</span>tokens
Y_test <span style="color:#f92672">=</span> test_df<span style="color:#f92672">.</span>label

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;X_train shape: &#39;</span>, X_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Y_train shape: &#39;</span>, Y_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">X_test shape: &#39;</span>, X_test<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Y_test shape: &#39;</span>, Y_test<span style="color:#f92672">.</span>shape)</code></pre></div>
<pre><code>X_train shape:  (136927,)
Y_train shape:  (136927,)

X_test shape:  (45780,)
Y_test shape:  (45780,)
</code></pre>

<h4 id="padding">Padding</h4>

<p>Time step은 40으로 고정한다. 리뷰마다 토큰의 수가 다르므로 40이 안되면 0으로 채우고(padding) 40이 넘으면 그 이상은 잘라 버린다(clipping)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras.preprocessing.sequence <span style="color:#f92672">import</span> pad_sequences

max_len<span style="color:#f92672">=</span><span style="color:#ae81ff">40</span>
X_train <span style="color:#f92672">=</span> pad_sequences(X_train, maxlen<span style="color:#f92672">=</span>max_len)
X_test <span style="color:#f92672">=</span> pad_sequences(X_test, maxlen<span style="color:#f92672">=</span>max_len)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;X_train shape: &#39;</span>, X_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;X_test shape: &#39;</span>, X_test<span style="color:#f92672">.</span>shape)</code></pre></div>
<pre><code>X_train shape:  (136927, 40)
X_test shape:  (45780, 40)
</code></pre>

<h4 id="이진-분류-binary-classification">이진 분류 (Binary classification)</h4>

<p>출력 데이터를 0과 1로 변환한다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelEncoder

encoder <span style="color:#f92672">=</span> LabelEncoder()
<span style="color:#75715e"># Train</span>
batch_size <span style="color:#f92672">=</span> Y_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
input_dim <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
Y_train <span style="color:#f92672">=</span> encoder<span style="color:#f92672">.</span>fit_transform(Y_train) <span style="color:#75715e"># Labeling</span>
Y_train <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>reshape(Y_train, (batch_size, input_dim)) <span style="color:#75715e"># Reshape</span>
<span style="color:#75715e"># Test</span>
batch_size <span style="color:#f92672">=</span> Y_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
Y_test <span style="color:#f92672">=</span> encoder<span style="color:#f92672">.</span>transform(Y_test) <span style="color:#75715e"># Labeling</span>
Y_test <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>reshape(Y_test, (batch_size, input_dim)) <span style="color:#75715e"># Reshape</span>

<span style="color:#66d9ef">print</span>(Y_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(Y_test<span style="color:#f92672">.</span>shape)</code></pre></div>
<pre><code>(136927, 1)
(45780, 1)
</code></pre>

<h3 id="모델링-modeling">모델링 (Modeling)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tensorflow.keras <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> tensorflow.keras.layers <span style="color:#f92672">import</span> Dense, Embedding, LSTM

model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(Embedding(max_words, <span style="color:#ae81ff">128</span>))
model<span style="color:#f92672">.</span>add(LSTM(<span style="color:#ae81ff">128</span>, dropout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, recurrent_dropout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>))
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sigmoid&#39;</span>))
model<span style="color:#f92672">.</span>compile(loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;binary_crossentropy&#39;</span>, optimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adam&#39;</span>, metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])</code></pre></div>
<h3 id="모델-훈련-train-model">모델 훈련 (Train Model)</h3>

<p>커피 한잔 하세여~ ☕️</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hist <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(X_train, Y_train, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)</code></pre></div>
<pre><code>Epoch 1/5
136927/136927 [==============================] - 429s 3ms/sample - loss: 0.3903 - acc: 0.8231
Epoch 2/5
136927/136927 [==============================] - 429s 3ms/sample - loss: 0.3104 - acc: 0.8662
Epoch 3/5
136927/136927 [==============================] - 430s 3ms/sample - loss: 0.2687 - acc: 0.8867
Epoch 4/5
136927/136927 [==============================] - 430s 3ms/sample - loss: 0.2322 - acc: 0.9037
Epoch 5/5
136927/136927 [==============================] - 430s 3ms/sample - loss: 0.1984 - acc: 0.9197
</code></pre>

<h3 id="모델-테스트-test-model">모델 테스트 (Test Model)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">loss, acc <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>evaluate(X_test, Y_test, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test loss:&#39;</span>, loss)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test accuracy:&#39;</span>, acc)</code></pre></div>
<pre><code>45780/45780 [==============================] - 24s 519us/sample - loss: 0.4006 - acc: 0.8480
Test loss: 0.4006009472697622
Test accuracy: 0.8479904
</code></pre>

<h3 id="모델-저장-save-model">모델 저장 (Save Model)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os

save_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;keras_naver_review_trained_model.h5&#39;</span>

<span style="color:#75715e"># Save model and weights</span>
model_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(save_dir, model_name)
model<span style="color:#f92672">.</span>save(model_path)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Saved trained model at </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> &#39;</span> <span style="color:#f92672">%</span> model_path)</code></pre></div>
<pre><code>Saved trained model at /home/dataman/myWork/deeplearning/keras_naver_review_trained_model.h5 
</code></pre>

<h2 id="해결-solution">해결 (Solution)</h2>

<p>⚙️ 엔지니어</p>

<blockquote>
<p>review_text에 리뷰를 적어서 실행하면<br />
감성 분석 예측 결과가 나옵니다.<br />
정확도는 84% 입니다.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span>  tensorflow.keras.models <span style="color:#f92672">import</span> load_model
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pickle

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_tokenizer</span>(path):
    <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
        tokenizer <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>load(f)
    <span style="color:#66d9ef">return</span> tokenizer

load_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;keras_naver_review_trained_model.h5&#39;</span>
tokenizer_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;keras_naver_review_tokenizer.pickle&#39;</span>
model_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(load_dir, model_name)
tokenizer_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(load_dir, tokenizer_name)

model <span style="color:#f92672">=</span> load_model(model_path)
tokenizer <span style="color:#f92672">=</span> load_tokenizer(tokenizer_path)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> PyKomoran <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">from</span> tensorflow.keras.preprocessing.sequence <span style="color:#f92672">import</span> pad_sequences

max_len<span style="color:#f92672">=</span><span style="color:#ae81ff">40</span>
komoran <span style="color:#f92672">=</span> Komoran(<span style="color:#e6db74">&#34;STABLE&#34;</span>)
stop_pos_tags <span style="color:#f92672">=</span>  [<span style="color:#e6db74">&#39;IC&#39;</span>, <span style="color:#e6db74">&#39;JKS&#39;</span>, <span style="color:#e6db74">&#39;JKC&#39;</span>, <span style="color:#e6db74">&#39;JKG&#39;</span>, <span style="color:#e6db74">&#39;JKO&#39;</span>, <span style="color:#e6db74">&#39;JKB&#39;</span>, <span style="color:#e6db74">&#39;JKV&#39;</span>, <span style="color:#e6db74">&#39;JKQ&#39;</span>, <span style="color:#e6db74">&#39;JX&#39;</span>, 
                   <span style="color:#e6db74">&#39;EF&#39;</span>, <span style="color:#e6db74">&#39;ETN&#39;</span>, <span style="color:#e6db74">&#39;ETM&#39;</span>, <span style="color:#e6db74">&#39;XSA&#39;</span>, <span style="color:#e6db74">&#39;SF&#39;</span>, <span style="color:#e6db74">&#39;SP&#39;</span>, <span style="color:#e6db74">&#39;SS&#39;</span>, <span style="color:#e6db74">&#39;SE&#39;</span>, <span style="color:#e6db74">&#39;SO&#39;</span>, <span style="color:#e6db74">&#39;SL&#39;</span>, <span style="color:#e6db74">&#39;SH&#39;</span>, 
                   <span style="color:#e6db74">&#39;SW&#39;</span>, <span style="color:#e6db74">&#39;NF&#39;</span>, <span style="color:#e6db74">&#39;NV&#39;</span>, <span style="color:#e6db74">&#39;SN&#39;</span>, <span style="color:#e6db74">&#39;NA&#39;</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tokenize</span>(corpus, stop_pos_tags):
    result <span style="color:#f92672">=</span> []
    pairs <span style="color:#f92672">=</span> komoran<span style="color:#f92672">.</span>get_list(corpus)
    <span style="color:#66d9ef">for</span> pair <span style="color:#f92672">in</span> pairs:
        morph <span style="color:#f92672">=</span> pair<span style="color:#f92672">.</span>get_first()
        pos <span style="color:#f92672">=</span> pair<span style="color:#f92672">.</span>get_second()
        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> stop_pos_tags:
            <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;VV&#39;</span>, <span style="color:#e6db74">&#39;VA&#39;</span>, <span style="color:#e6db74">&#39;VX&#39;</span>, <span style="color:#e6db74">&#39;VCP&#39;</span>, <span style="color:#e6db74">&#39;VCN&#39;</span>]:
                morph <span style="color:#f92672">=</span> morph <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;다&#39;</span>
            result<span style="color:#f92672">.</span>append(morph)
    <span style="color:#66d9ef">return</span> result

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_sentiment</span>(text, model):
    tokens <span style="color:#f92672">=</span> []
    tokens<span style="color:#f92672">.</span>append(tokenize(text, stop_pos_tags))
    tokens <span style="color:#f92672">=</span> tokenizer<span style="color:#f92672">.</span>texts_to_sequences(tokens)
    x_test <span style="color:#f92672">=</span> pad_sequences(tokens, maxlen<span style="color:#f92672">=</span>max_len)
    predict <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(x_test)
    <span style="color:#66d9ef">if</span> predict[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.5</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;GOOD&#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;BAD&#39;</span>

review_text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;재미있는영화입니다.&#39;</span>
result <span style="color:#f92672">=</span> predict_sentiment(review_text, model)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} : {}&#39;</span><span style="color:#f92672">.</span>format(review_text, result))</code></pre></div>
<pre><code>재미있는영화입니다. : GOOD
</code></pre>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/pos/" rel="tag">PoS</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/tokenization/" rel="tag">Tokenization</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/lstm/" rel="tag">LSTM</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/many-to-one/" rel="tag">many-to-one</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/recurrent_neural_network/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Recurrent Neural Network</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/monte_carlo_learning/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Monte Carlo Learning</p></a>
	</div>
</nav>
<script src="https://utteranc.es/client.js"
        repo="skettee/blog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 skettee.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>